<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home Lab â€” Angel Vasquez</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    .lab-wrapper { max-width: 1100px; margin: 0 auto; padding: 2rem 1rem; }
    .lab-grid { display: grid; gap: 1.1rem; }
    .lab-card {
      background: var(--card, #121318);
      border: 1px solid var(--border, rgba(255,255,255,.08));
      border-radius: 16px;
      padding: 1rem;
      box-shadow: var(--shadow, 0 10px 30px rgba(0,0,0,.35));
    }
    .lab-card h2 { margin: .2rem 0 .6rem }
    .toc { display:flex; flex-wrap:wrap; gap:.5rem; margin:.5rem 0 1rem }
    .toc a {
      padding:.35rem .6rem; border:1px solid var(--border, rgba(255,255,255,.08));
      border-radius:999px; text-decoration:none
    }
    .lab-card img { max-width: 100%; height: auto; border-radius: 8px; }
    pre { overflow:auto; }
    .muted { color: var(--muted, #9aa3b2); }
  </style>
</head>
<body>
  <header class="site-header">
    <nav class="nav container">
      <div>
        <h1 class="logo">Angel Vasquez</h1>
        <p>Cybersecurity Student â€¢ Problem Solver â€¢ Lifelong Learner</p>
      </div>
      <ul class="nav-links">
        <li><a href="index.html#about">About</a></li>
        <li><a href="index.html#projects">Projects</a></li>
        <li><a href="index.html#resume">Resume</a></li>
        <li><a href="index.html#contact">Contact</a></li>
        <li><a href="Blog/index.html">Blog</a></li>
        <li><a aria-current="page" href="homelab.html">Home Lab</a></li>
      </ul>
    </nav>
  </header>

  <main class="lab-wrapper">
    <h1>Home Lab</h1>
    <p class="tagline muted">Notes and configs from my networking, VLAN, VPN, and router builds.</p>

    <div class="lab-card">
      <strong>On this page</strong>
      <div id="toc" class="toc"></div>
    </div>

    <div id="content" class="lab-grid"></div>
  </main>

  <footer class="site-footer">
    <p>Â© 2025 Angel Vasquez</p>
  </footer>

  <script>
    const BASE = "notes/homelab/";
    const SECTIONS = [
      { id: "overview", title: "The Home Lab (Overview)", file: "The Home Lab.md" },
      { id: "gmk",      title: "GMK Tech Mini PC (Router)", file: "GMK Tech Mini PC (router).md" },
      { id: "modem",    title: "Hitron Cable Modem",        file: "Hitron cable modem.md" },
      { id: "desktop",  title: "My Main Desktop",           file: "My main desktop.md" },
    ];

    const titleToAnchor = Object.fromEntries(
      SECTIONS.map(s => [s.title.toLowerCase().replace(/\s+/g,' ').trim(), `#${s.id}`])
    );

    const joinEncoded = (base, segment) => base + encodeURIComponent(segment).replace(/%2F/gi,'/');

    function preprocessObsidian(md) {
      md = md.replace(/!\[\[([^|\]]+)(?:\|([^]]*))?\]\]/g, (_m, file, alt) => {
        const clean = String(file).trim();
        const url = joinEncoded(BASE + "assets/", clean);
        return `![${alt ? alt.trim() : ""}](${url})`;
      });
      md = md.replace(/\[\[([^|\]]+)(?:\|([^]]+))?\]\]/g, (_m, target, text) => {
        const t = String(target).trim().toLowerCase().replace(/\s+/g,' ');
        const href = titleToAnchor[t] || '#';
        return `[${(text || target).trim()}](${href})`;
      });
      return md;
    }

    // ðŸ”§ NEW: Smart image resolver that auto-fixes missing paths/extensions
    function attachImageFallbacks(root, BASE) {
      root.querySelectorAll('img').forEach(img => {
        const original = img.getAttribute('src');
        if (!original) return;

        const url = new URL(original, location.href);
        const path = url.pathname;
        const file = path.split('/').pop() || "";
        const dir  = path.slice(0, path.lastIndexOf('/') + 1);

        const name = file.replace(/\.[^.]+$/, '');
        const ext  = (file.match(/\.[^.]+$/) || [''])[0];

        const baseAssets = BASE + "assets/";
        const baseRoot   = BASE;

        const nameVariants = Array.from(new Set([
          name,
          name.replace(/ /g, '%20'),
          name.replace(/ /g, '_'),
          name.replace(/[()]/g, ''),
          name.toLowerCase(),
          name.replace(/ /g, '_').toLowerCase(),
        ]));

        const extVariants = Array.from(new Set([
          ext || '.png', '.png', '.jpg', '.jpeg', '.webp'
        ]));

        const bases = [dir, baseAssets, baseRoot];

        const candidates = [];
        for (const base of bases) {
          for (const n of nameVariants) {
            for (const e of extVariants) {
              const cand = base + n + e;
              if (!candidates.includes(cand)) candidates.push(cand);
            }
          }
        }

        let i = 0;
        img.addEventListener('error', function handler () {
          if (i >= candidates.length) {
            img.removeEventListener('error', handler);
            return;
          }
          img.src = candidates[i++];
        });
      });
    }

    async function render() {
      const content = document.getElementById("content");
      const toc = document.getElementById("toc");

      toc.innerHTML = SECTIONS.map(s => `<a href="#${s.id}">${s.title}</a>`).join("");

      for (const s of SECTIONS) {
        const card = document.createElement("section");
        card.className = "lab-card";
        card.id = s.id;

        try {
          const res = await fetch(joinEncoded(BASE, s.file));
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          let md = await res.text();
          md = preprocessObsidian(md);

          const html = marked.parse(md);
          card.innerHTML = `<h2>${s.title}</h2>${html}`;

          // Apply the smart image resolver here âœ…
          attachImageFallbacks(card, BASE);
        } catch (e) {
          card.innerHTML = `<h2>${s.title}</h2><p class="muted">Could not load <code>${BASE}${s.file}</code> (${e.message}).</p>`;
        }

        content.appendChild(card);
      }
    }

    render();
  </script>
</body>
</html>

