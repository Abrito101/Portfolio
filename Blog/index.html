<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog — Angel Vasquez</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css">

  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --panel-2: #0b1020;
      --border: #334155;
      --text: #e2e8f0;
      --text-bright: #f8fafc;
      --muted: #94a3b8;
      --link: #60a5fa;
      --max: 1100px;
      --content: 760px;
      --radius: 14px;
    }

    body {
      margin: 0;
      font-family: Poppins, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.7;
    }

    h1, h2, h3 {
      color: var(--text-bright);
      font-weight: 700;
    }

    a {
      color: var(--link);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .container {
      max-width: var(--max);
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .site-header {
      background: var(--panel-2);
      border-bottom: 1px solid var(--border);
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .nav-links {
      list-style: none;
      display: flex;
      gap: 1rem;
      padding: 0;
      margin: 0;
    }

    .intro {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .intro p {
      color: var(--muted);
    }

    main {
      display: flex;
      gap: 2rem;
      justify-content: center;
    }

    /* Blog cards */
    #list {
      flex: 3;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      max-width: var(--content);
      margin: 0 auto;
    }

    .post-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
      text-align: center; /* Center everything */
      transition: transform 0.15s ease;
    }

    .post-card:hover {
      transform: scale(1.01);
    }

    .post-card h3 {
      margin-bottom: 0.5rem;
      font-size: 1.6rem;
    }

    .meta {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 1rem;
    }

    .tags {
      margin-top: 1rem;
    }

    .tag {
      display: inline-block;
      background: var(--panel-2);
      color: var(--text);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      margin: 0 4px;
      border: 1px solid var(--border);
    }

    #reader {
      max-width: var(--content);
      margin: 0 auto;
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <header class="site-header">
    <nav class="nav container">
      <div>
        <h1 class="logo">Angel Vasquez</h1>
        <p>Cybersecurity Student • Problem Solver • Lifelong Learner</p>
      </div>
      <ul class="nav-links">
        <li><a href="../index.html#about">About</a></li>
        <li><a href="../index.html#projects">Projects</a></li>
        <li><a href="../index.html#resume">Resume</a></li>
        <li><a href="../index.html#contact">Contact</a></li>
        <li><a href="./index.html">Blog</a></li>
        <li><a href="../homelab.html">Home Lab</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <section style="flex:3">
      <div class="intro">
        <h2>Blog</h2>
        <p>Homelab builds, OPNsense tricks, SOC study notes, and blue-team write-ups.</p>
      </div>
      <div id="list"></div>
    </section>

    <aside style="flex:1">
      <div class="card" style="padding:1rem; margin-bottom:1rem;">
        <h3>Popular Topics</h3>
        <div id="tag-cloud"></div>
      </div>
      <div class="card" style="padding:1rem;">
        <h3>New here?</h3>
        <p>Start with my <a href="#" id="latest-link">latest post</a> or check out <a href="../index.html#projects">Projects</a>.</p>
      </div>
    </aside>
  </main>

  <section class="container hidden" id="reader">
    <a href="#" onclick="showList();return false;" style="color:#60a5fa;">← Back</a>
    <div id="content"></div>
  </section>

  <footer class="site-footer container">
    <p>© 2025 Angel Vasquez</p>
  </footer>

  <!-- Markdown renderer -->
<script src="https://unpkg.com/marked/marked.min.js"></script>
<script>
  const listEl = document.getElementById('list');
  const reader = document.getElementById('reader');
  const contentEl = document.getElementById('content');
  const tagCloud = document.getElementById('tag-cloud');
  const latestLink = document.getElementById('latest-link');


  async function fetchJSON(url){
    const u = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
    log('Fetching JSON:', u);
    const res = await fetch(u);
    if(!res.ok) throw new Error(`HTTP ${res.status} ${url}`);
    const txt = await res.text();
    log('posts.json raw:', txt.slice(0, 200) + (txt.length>200?'…':''));
    try { return JSON.parse(txt); } catch(e){ throw new Error('Invalid JSON: ' + e.message); }
  }

  function card(post){
    const el = document.createElement('div');
    el.className = 'card post-card';
    const file = (post.file || '').trim();

    const title = document.createElement('h3');
    title.textContent = post.title || file || 'Untitled';
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = post.date ? formatDate(post.date) : '';
    const sum = document.createElement('p');
    sum.className = 'meta';
    sum.textContent = post.summary || '';

    const tags = document.createElement('div');
    tags.className = 'tags';
    (post.tags || []).forEach(t => {
      const span = document.createElement('span');
      span.className = 'tag';
      span.textContent = t;
      tags.appendChild(span);
    });

    el.appendChild(title);
    el.appendChild(meta);
    el.appendChild(sum);
    el.appendChild(tags);

    if (file) el.onclick = () => openPost(file);
    else el.style.opacity = 0.6;

    return el;
  }

  function formatDate(s){
    const d = new Date(s);
    return isNaN(d) ? (s || '') :
      d.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
  }

  function buildTagCloud(posts){
    const counts = new Map();
    posts.forEach(p => (p.tags||[]).forEach(t => counts.set(t, (counts.get(t)||0) + 1)));
    tagCloud.innerHTML = '';
    [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12).forEach(([t,n]) => {
      const a = document.createElement('a');
      a.href = '#';
      a.className = 'tag';
      a.textContent = `${t} (${n})`;
      a.onclick = (e)=>{ e.preventDefault(); filterByTag(t); };
      tagCloud.appendChild(a);
    });
  }

  let allPosts = [];

  async function listPosts(){
    try {
      // Try the obvious path first
      let posts;
      try {
        posts = await fetchJSON('./posts.json');
      } catch (e1) {
        // Try absolute path as a fallback for GH Pages base-path issues
        log('Retry posts.json at absolute path…');
        posts = await fetchJSON('/Portfolio/Blog/posts.json');
      }

      allPosts = posts;
      log('Parsed posts.json:', JSON.stringify(allPosts));

      // Only keep objects with a string 'file'
      const safe = allPosts.filter(p => p && typeof p.file === 'string' && p.file.trim());
      if (safe.length !== allPosts.length) log('Some posts ignored (missing "file").');

      safe.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
      listEl.innerHTML = '';
      safe.forEach(p => listEl.appendChild(card(p)));
      if (safe[0]) latestLink.onclick = (e)=>{ e.preventDefault(); openPost(safe[0].file); };
      buildTagCloud(safe);
    } catch (err) {
      uiError('Could not load posts.json → ' + err.message);
    }
  }

  function filterByTag(tag){
    listEl.innerHTML = '';
    allPosts.filter(p => (p.tags||[]).includes(tag)).forEach(p => listEl.appendChild(card(p)));
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function showList(){
    reader.classList.add('hidden');
    document.querySelector('main').classList.remove('hidden');
    history.pushState({}, '', location.pathname);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  async function tryFetchOne(url) {
    const u = url + '?v=' + Date.now();
    log('Try:', u);
    const res = await fetch(u);
    log(' →', res.status, res.ok ? 'OK' : 'FAIL');
    if (!res.ok) return null;
    return res.text();
  }

  async function openPost(file){
    try {
      // sanitize: remove accidental "posts/" prefix and encode
      const just = file.replace(/^posts\//i, '').trim();
      const enc = encodeURIComponent(just);

      // Try common folder casings/paths
      const candidates = [
        `./posts/${enc}`,
        `./Posts/${enc}`,
        `/Portfolio/Blog/posts/${enc}`,
        `/Portfolio/Blog/Posts/${enc}`
      ];

      let text = null, used = '';
      for (const c of candidates) {
        const t = await tryFetchOne(c);
        if (t !== null) { text = t; used = c; break; }
      }
      if (text === null) throw new Error('Could not fetch markdown from any known path. Check folder name/case.');

      log('Loaded post from:', used);

      const html = renderMarkdownWithFrontMatter(text);
      contentEl.innerHTML = html;
      document.querySelector('main').classList.add('hidden');
      reader.classList.remove('hidden');
      history.pushState({}, '', `#${encodeURIComponent(just)}`);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (e) {
      console.error(e);
      alert('Failed to load post: ' + e.message);
    }
  }

  function renderMarkdownWithFrontMatter(md){
    const fm = md.match(/^---[\s\S]*?---/);
    let meta = {}; let body = md;
    if (fm){
      const yaml = fm[0].replace(/^---|---$/g,'').trim();
      yaml.split(/\n/).forEach(line => {
        const m = line.match(/^(\w+):\s*(.*)$/);
        if (m){
          let v = m[2].trim();
          v = v.replace(/^"|"$/g,'').replace(/^'|'$/g,'');
          meta[m[1]] = v;
        }
      });
      body = md.slice(fm[0].length).trimStart();
    }
    const cover = meta.cover ? `<p><img src="${meta.cover}" alt="cover"/></p>` : '';
    const head = `<div style="padding:1rem 1rem 0;text-align:center"><h1 style="margin:.2rem 0">${meta.title||''}</h1><div class="meta">${meta.date?formatDate(meta.date):''}</div></div>`;
    const rendered = marked.parse(body);
    return `<div class="card" style="padding:1rem;text-align:center">${cover}${head}${rendered}</div>`;
  }

  window.addEventListener('load', async () => {
    await listPosts();
    const hash = decodeURIComponent(location.hash.replace('#',''));
    if (hash) openPost(hash);
  });
</script>

</body>
</html>
